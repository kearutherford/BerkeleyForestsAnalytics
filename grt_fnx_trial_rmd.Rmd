
Example dataset 
```{r}
# division 240, M210, 240, M220 
data <- data.frame(
  species = c(202, 316, 631, 802, 202),
  status = c(1, 1, 0, 1, 1),
  dbh = c(20, 11.1, 11.3, 18.1, 4.8),
  ht1 = c(110, 38, 28, 65, 14),
  ht2 = c(NA, NA, 21, 59, 12),
  crown_ratio = c(NA, NA, NA, 0.3, 0.4),
  top = c("Y", "Y", "N", "N", "N"),
  decay_class = c(NA, NA, 2, NA, NA),
  cull = c(0, 3, 10, 2, 0),
  division = c("240", "M210", "240", "M220", "240")
)

data
```

```{r}
use_data(Table_S1a, 
         Table_S1b,
         
         Table_S2a,
         Table_S2b,
         
         Table_S3a,
         Table_S3b,
         
         Table_S4a,
         Table_S4b,
         
         Table_S5a,
         Table_S5b,
         
         Table_S6a,
         Table_S6b,
         
         Table_S7a,
         Table_S7b,
         
         Table_S8a,
         Table_S8b,
         
         Table_S9a,
         Table_S9b,
         
         Table_S10a,
         Table_S10b,
         
         Table_S11, 
         
         REF_SPECIES_BFA,
         
         discount,
         
         results_by_hand,
         
         internal = TRUE,
         
         overwrite = TRUE)
```

Internal datasets 
```{r}
REF_SPECIES_BFA <- read.csv(here::here("gtr_data", "REF_SPECIES_BFA.csv"))
REF_SPECIES_BFA$k <- ifelse(REF_SPECIES_BFA$type == "S", 9, 11)
REF_SPECIES_BFA$DensProp <- ifelse(REF_SPECIES_BFA$type == "S", 0.92, 0.54)
REF_SPECIES_BFA$species <- as.character(REF_SPECIES_BFA$species)
REF_SPECIES_BFA$JENKINS_SPGRPCD <- as.character(REF_SPECIES_BFA$JENKINS_SPGRPCD)
REF_SPECIES_BFA
```

```{r}
Table_S1a <- read.csv(here::here("gtr_data", "Table S1a_volib_coefs_spcd.csv"), na.strings = c(""))
Table_S1a$SPCD <- as.character(Table_S1a$SPCD)
Table_S1a$model <- as.character(Table_S1a$model)
Table_S1a
```

```{r}
Table_S1b <- read.csv(here::here("gtr_data", "Table S1b_volib_coefs_jenkins.csv"), na.strings = c(""))
Table_S1b$JENKINS_SPGRPCD <- as.character(Table_S1b$JENKINS_SPGRPCD)
Table_S1b$model <- as.character(Table_S1b$model)
Table_S1b
```

```{r}
Table_S2a <- read.csv(here::here("gtr_data", "Table S2a_volbk_coefs_spcd.csv"), na.strings = c(""))
Table_S2a$SPCD <- as.character(Table_S2a$SPCD)
Table_S2a$model <- as.character(Table_S2a$model)
Table_S2a
```

```{r}
Table_S2b <- read.csv(here::here("gtr_data", "Table S2b_volbk_coefs_jenkins.csv"), na.strings = c(""))
Table_S2b$JENKINS_SPGRPCD <- as.character(Table_S2b$JENKINS_SPGRPCD)
Table_S2b$model <- as.character(Table_S2b$model)
Table_S2b
```

```{r}
Table_S3a <- read.csv(here::here("gtr_data", "Table S3a_volob_coefs_spcd.csv"), na.strings = c(""))
Table_S3a$SPCD <- as.character(Table_S3a$SPCD)
Table_S3a$model <- as.character(Table_S3a$model)
Table_S3a
```

```{r}
Table_S3b <- read.csv(here::here("gtr_data", "Table S3b_volob_coefs_jenkins.csv"), na.strings = c(""))
Table_S3b$JENKINS_SPGRPCD <- as.character(Table_S3b$JENKINS_SPGRPCD)
Table_S3b$model <- as.character(Table_S3b$model)
Table_S3b
```

```{r}
Table_S4a <- read.csv(here::here("gtr_data", "Table S4a_rcumob_coefs_spcd.csv"), na.strings = c(""))
Table_S4a$SPCD <- as.character(Table_S4a$SPCD)
Table_S4a$model <- as.character(Table_S4a$model)
Table_S4a
```

```{r}
Table_S4b <- read.csv(here::here("gtr_data", "Table S4b_rcumob_coefs_jenkins.csv"), na.strings = c(""))
Table_S4b$JENKINS_SPGRPCD <- as.character(Table_S4b$JENKINS_SPGRPCD)
Table_S4b$model <- as.character(Table_S4b$model)
Table_S4b
```

```{r}
Table_S5a <- read.csv(here::here("gtr_data", "Table S5a_rcumib_coefs_spcd.csv"), na.strings = c(""))
Table_S5a$SPCD <- as.character(Table_S5a$SPCD)
Table_S5a$model <- as.character(Table_S5a$model)
Table_S5a
```

```{r}
Table_S5b <- read.csv(here::here("gtr_data", "Table S5b_rcumib_coefs_jenkins.csv"), na.strings = c(""))
Table_S5b$JENKINS_SPGRPCD <- as.character(Table_S5b$JENKINS_SPGRPCD)
Table_S5b$model <- as.character(Table_S5b$model)
Table_S5b
```

```{r}
Table_S6a <- read.csv(here::here("gtr_data", "Table S6a_bark_biomass_coefs_spcd.csv"), na.strings = c(""))
Table_S6a$SPCD <- as.character(Table_S6a$SPCD)
Table_S6a$model <- as.character(Table_S6a$model)
Table_S6a
```

```{r}
Table_S6b <- read.csv(here::here("gtr_data", "Table S6b_bark_biomass_coefs_jenkins.csv"), na.strings = c(""))
Table_S6b$JENKINS_SPGRPCD <- as.character(Table_S6b$JENKINS_SPGRPCD)
Table_S6b$model <- as.character(Table_S6b$model)
Table_S6b
```

```{r}
Table_S7a <- read.csv(here::here("gtr_data", "Table S7a_branch_biomass_coefs_spcd.csv"), na.strings = c(""))
Table_S7a$SPCD <- as.character(Table_S7a$SPCD)
Table_S7a$model <- as.character(Table_S7a$model)
Table_S7a
```

```{r}
Table_S7b <- read.csv(here::here("gtr_data", "Table S7b_branch_biomass_coefs_jenkins.csv"), na.strings = c(""))
Table_S7b$JENKINS_SPGRPCD <- as.character(Table_S7b$JENKINS_SPGRPCD)
Table_S7b$model <- as.character(Table_S7b$model)
Table_S7b
```

```{r}
Table_S8a <- read.csv(here::here("gtr_data", "Table S8a_total_biomass_coefs_spcd.csv"), na.strings = c(""))
Table_S8a$SPCD <- as.character(Table_S8a$SPCD)
Table_S8a$model <- as.character(Table_S8a$model)
Table_S8a
```

```{r}
Table_S8b <- read.csv(here::here("gtr_data", "Table S8b_total_biomass_coefs_jenkins.csv"), na.strings = c(""))
Table_S8b$JENKINS_SPGRPCD <- as.character(Table_S8b$JENKINS_SPGRPCD)
Table_S8b$model <- as.character(Table_S8b$model)
Table_S8b
```

```{r}
Table_S9a <- read.csv(here::here("gtr_data", "Table S9a_foliage_coefs_spcd.csv"), na.strings = c(""))
Table_S9a$SPCD <- as.character(Table_S9a$SPCD)
Table_S9a$model <- as.character(Table_S9a$model)
Table_S9a
```

```{r}
Table_S9b <- read.csv(here::here("gtr_data", "Table S9b_foliage_coefs_jenkins.csv"), na.strings = c(""))
Table_S9b$JENKINS_SPGRPCD <- as.character(Table_S9b$JENKINS_SPGRPCD)
Table_S9b$equation <- as.character(Table_S9b$equation)
Table_S9b
```

```{r}
Table_S10a <- read.csv(here::here("gtr_data", "Table S10a_fia_wood_c_frac_live.csv"))
Table_S10a$SPCD <- as.character(Table_S10a$SPCD)
Table_S10a
```

```{r}
Table_S10b <- read.csv(here::here("gtr_data", "Table S10b_fia_wood_c_frac_dead.csv"))
Table_S10b$S.H <- ifelse(Table_S10b$S.H == "Hardwood", "H", "S")
Table_S10b$Decay.code <- as.character(Table_S10b$Decay.code)
Table_S10b
```

```{r}
Table_S11 <- read.csv(here::here("gtr_data", "Table S11_mean_crprop.csv"))
Table_S11$HWD <- ifelse(Table_S11$HWD.Y.N == "Y", "H", "S")
Table_S11 <- subset(Table_S11, select = -c(HWD.Y.N))
Table_S11
```


Supporting functions 
```{r}
EQ_set <- function(table_data, tree_data) {
  
  if(table_data$model[1] == "1") {

    y <- table_data$a[1]*(tree_data$dbh[1]^table_data$b[1])*(tree_data$ht1[1]^table_data$c[1]) 
  
  } else if(table_data$model[1] == "2") {
      
    if(tree_data$dbh[1] < tree_data$k[1]) {
        
      y <- table_data$a[1]*(tree_data$dbh[1]^table_data$b[1])*(tree_data$ht1[1]^table_data$c[1])
        
    } else if(tree_data$dbh[1] >= tree_data$k[1]) {
        
      y <- table_data$a[1]*(tree_data$k[1]^(table_data$b[1]-table_data$b1[1]))*(tree_data$dbh[1]^table_data$b1[1])*(tree_data$ht1[1]^table_data$c[1]) 
        
    }
      
  } else if(table_data$model[1] == "3") {
  
    y <- table_data$a[1]*(tree_data$dbh[1]^(table_data$a1[1]*(1-exp(-table_data$b[1]*tree_data$dbh[1]))^table_data$c1[1]))*(tree_data$ht1[1]^table_data$c[1])
  
  } else if(table_data$model[1] == "4") {
  
    y <- table_data$a[1]*(tree_data$dbh[1]^table_data$b[1])*(tree_data$ht1[1]^table_data$c[1])*exp(-(table_data$b1[1]*tree_data$dbh[1]))
  
  } else if(table_data$model[1] == "5") {
    
    y <- table_data$a[1]*(tree_data$dbh[1]^table_data$b[1])*(tree_data$ht1[1]^table_data$c[1])*tree_data$WDSG[1] 
    
  }

  return(y)
  
}
```

```{r}
EQ_6 <- function(h, table_data, tree_data) {
  
  y <- (1 - (1 - h/tree_data$ht1[1])^table_data$alpha[1])^table_data$beta[1]
  return(y)
  
}
```

```{r}
EQ_7 <- function(h, d, table_data_1, table_data_2, tree_data) {
  
  d - (table_data_1$a[1]*tree_data$dbh[1]^table_data_1$b[1]*tree_data$ht1[1]^table_data_1$c[1]/0.005454154/tree_data$ht1[1]*table_data_2$alpha[1]*table_data_2$beta[1]*(1-(h/tree_data$ht1[1]))^(table_data_2$alpha[1]-1)*(1-(1-(h/tree_data$ht1[1]))^table_data_2$alpha[1])^(table_data_2$beta[1]-1))^0.5
  
}
```

```{r}
Table_Pull <- function(table_data_a, table_data_b, tree_data) {

    if(tree_data$species[1] %in% table_data_a$SPCD) {
  
      table_pull <- subset(table_data_a, SPCD == tree_data$species[1])
  
      if(tree_data$division[1] %in% table_pull$DIVISION) {
    
        return_table <- subset(table_pull, DIVISION == tree_data$division[1])
      
      } else {
      
        return_table <- subset(table_pull, is.na(DIVISION))
      
      }
      
    } else {
      
      return_table <- subset(table_data_b, JENKINS_SPGRPCD == tree_data$JENKINS_SPGRPCD[1])
      
    }
  
  return(return_table)
      
} 
```

```{r}
Table_11_Pull <- function(table_data, tree_data) {

    if(tree_data$division[1] %in% table_data$Division) {
  
      return_pull <- subset(table_data, Division == tree_data$division[1] & HWD == tree_data$type[1])
      
    } else {
      
      return_table <- subset(table_data, Division == "UNDEFINED" & HWD == tree_data$type[1])
      
    }
  
  return(return_table)
      
} 
```


```{r}
NSVBCalcs(data = data)
```

```{r}
# include this in the prep function 
data <- merge(data, REF_SPECIES_BFA, by = "species", all.x = TRUE, all.y = FALSE)
data <- merge(data, Table_1, by = c("type", "decay_class"), all.x = TRUE, all.y = FALSE)

data$path <- paste0(data$top,'_',data$status)
data$path[data$path == "Y_1"] <- "1"
data$path[data$path == "N_1"] <- "2"
data$path[data$path == "Y_0"] <- "3"
data$path[data$path == "N_0"] <- "4"

data 
```

Main function 
```{r}
# other inputs that need to be added to the top level function 
# sp_codes = "4letter", input_units = "metric", output_units = "metric"

NSVBCalcs <- function(data) {
  
  data$total_wood_bio <- as.double(NA)
  data$total_bark_bio <- as.double(NA)
  data$total_branch_bio <- as.double(NA)
  data$total_ag_bio <- as.double(NA)
  data$merch_wood_bio <- as.double(NA)
  data$merch_bark_bio <- as.double(NA)
  data$merch_total_bio <- as.double(NA)
  data$merch_top_bio <- as.double(NA)
  data$stump_wood_bio <- as.double(NA)
  data$stump_bark_bio <- as.double(NA)
  data$stump_total_bio <- as.double(NA)
  data$foliage_bio <- as.double(NA)
  data$carbon_frac <- as.double(NA)
  
  n <- nrow(data)

  for (i in 1:n) {
  
    # STEP 1: predict gross total stem wood volume 
    Table_S1_Pull <- Table_Pull(Table_S1a, Table_S1b, data[i,])
    Vtot_ib_Gross <- EQ_set(Table_S1_Pull, data[i,])
    
    # STEP 2: predict gross total stem bark volume
    Table_S2_Pull <- Table_Pull(Table_S2a, Table_S2b, data[i,])
    Vtot_bk_Gross <- EQ_set(Table_S2_Pull, data[i,])
    
    # STEP 3: obtain gross total stem outside-bark volume 
    Vtot_ob_Gross <- Vtot_ib_Gross + Vtot_bk_Gross 
    
    # If merchantable... 
    # STEP 4: estimate heights to merchantable top diameter
    # STEP 5: estimate stem component gross volumes 
    
    Table_S5_Pull <- Table_Pull(Table_S5a, Table_S5b, data[i,]) # Table_S5_Pull used in various calcs, not just for merch 
    
    if(data$dbh[i] >= 5) {
    
      Table_S3_Pull <- Table_Pull(Table_S3a, Table_S3b, data[i,])
      Table_S4_Pull <- Table_Pull(Table_S4a, Table_S4b, data[i,])
      
      EQ_7_hm <- uniroot(EQ_7, c(0,data$ht1[i]), tol = 0.001, maxiter = 100000, d = 4, table_data_1 = Table_S3_Pull, table_data_2 = Table_S4_Pull, tree_data = data[i,])
      h_m <- EQ_7_hm$root
  
      R_1 <- EQ_6(1, Table_S5_Pull, data[i,])
      R_m <- EQ_6(h_m, Table_S5_Pull, data[i,])
      
      Vmer_ib_Gross <- (R_m*Vtot_ib_Gross) - (R_1*Vtot_ib_Gross)
      Vmer_ob_Gross <- (R_m*Vtot_ob_Gross) - (R_1*Vtot_ob_Gross)
      Vmer_bk_Gross <- Vmer_ob_Gross - Vmer_ib_Gross
      
      Vstump_ob_Gross <- (R_1*Vtot_ob_Gross)
      Vstump_ib_Gross <- (R_1*Vtot_ib_Gross)
      Vstump_bk_Gross <- Vstump_ob_Gross - Vstump_ib_Gross
      
    }
    
    # PATH 1 (live, with intact top) ------------------------------------------>
    if(data$path[i] == "1") {
      
      # STEP 6: estimate stem component sound volumes 
      # Not a necessary step for this pathway 
      
      # STEP 7: convert total stem wood gross volume to biomass weight 
      Wtot_ib <- Vtot_ib_Gross*data$WDSG[i]*62.4
      Wtot_ib_red <- Vtot_ib_Gross*(1 - data$cull[i]/100*(1 - data$DensProp[i]))*data$WDSG[i]*62.4 
      
      # STEP 8: predict total stem bark biomass 
      Table_S6_Pull <- Table_Pull(Table_S6a, Table_S6b, data[i,])
      Wtot_bk <- EQ_set(Table_S6_Pull, data[i,])
      Wtot_bk_red <- Wtot_bk
      
      # STEP 9: predict total branch biomass 
      Table_S7_Pull <- Table_Pull(Table_S7a, Table_S7b, data[i,])
      Wbranch <- EQ_set(Table_S7_Pull, data[i,])
      Wbranchred <- Wbranch
      
    # PATH 2 (live, with broken top) ------------------------------------------>
    } else if(data$path[i] == "2") {
      
      # STEP 6: estimate stem component sound volumes 
      R_b <- EQ_6(data$ht2[i], Table_S5_Pull, data[i,])
      
      # If merchantable...
      if(data$dbh[i] >= 5) {
        
        if(data$ht2[i] < h_m) {
          
          Vmer_ib_Sound <- (R_b*Vtot_ib_Gross) - (R_1*Vtot_ib_Gross)
          Vmer_bk_Sound <- (R_b*Vtot_bk_Gross) - (R_1*Vtot_bk_Gross)
          
        } else {
          
          Vmer_ib_Sound <- Vmer_ib_Gross
          Vmer_bk_Sound <- Vmer_bk_Gross
          
        }
        
      }
      
      # STEP 7: convert total stem wood gross volume to biomass weight 
      Wtot_ib <- Vtot_ib_Gross*data$WDSG[i]*62.4 
      Wtot_ib_red <- (Vtot_ib_Gross*R_b)*(1 - data$cull[i]/100*(1 - data$DensProp[i]))*data$WDSG[i]*62.4
      
      # STEP 8: predict total stem bark biomass 
      Table_S6_Pull <- Table_Pull(Table_S6a, Table_S6b, data[i,])
      Wtot_bk <- EQ_set(Table_S6_Pull, data[i,])
      Wtot_bk_red <- Wtot_bk*R_b 
      
      # STEP 9: predict total branch biomass 
      Table_S7_Pull <- Table_Pull(Table_S7a, Table_S7b, data[i,])
      Wbranch <- EQ_set(Table_S7_Pull, data[i,])
      
      CR <- (data$ht1[i] - data$ht2[i]*(1 - data$crown_ratio[i]))/data$ht1[i]
      BranchRem <- (data$ht2[i] - data$ht1[i]*(1-CR))/(data$ht1[i]*CR)
      
      Wbranchred <- Wbranch*BranchRem
    
    # PATH 3 (dead, with intact top) ------------------------------------------>
    } else if(data$path[i] == "3") {
      
      # STEP 6: estimate stem component sound volumes 
      # Not a necessary step for this pathway 
      
      # STEP 7: convert total stem wood gross volume to biomass weight 
      Wtot_ib <- Vtot_ib_Gross*data$WDSG[i]*62.4 
      Wtot_ib_red <- Vtot_ib_Gross*data$WDSG[i]*data$wood_prop[i]*62.4
      
      # STEP 8: predict total stem bark biomass 
      Table_S6_Pull <- Table_Pull(Table_S6a, Table_S6b, data[i,])
      Wtot_bk <- EQ_set(Table_S6_Pull, data[i,])
      Wtot_bk_red <- Wtot_bk*data$wood_prop[i]*data$bark_prop[i]
      
      # STEP 9: predict total branch biomass 
      Table_S7_Pull <- Table_Pull(Table_S7a, Table_S7b, data[i,])
      Wbranch <- EQ_set(Table_S7_Pull, data[i,])
      Wbranchred <- Wbranch*data$wood_prop[i]*data$branch_prop[i]
      
    # PATH 4 (dead, with broken top) ------------------------------------------>
    } else if(data$path[i] == "4") {
      
      # STEP 6: estimate stem component sound volumes 
      R_b <- EQ_6(data$ht2[i], Table_S5_Pull, data[i,])
      
      # If merchantable...
      if(data$dbh[i] >= 5) {
        
        if(data$ht2[i] < h_m) {
          
          Vmer_ib_Sound <- (R_b*Vtot_ib_Gross) - (R_1*Vtot_ib_Gross)
          Vmer_bk_Sound <- (R_b*Vtot_bk_Gross) - (R_1*Vtot_bk_Gross)
          
        } else {
          
          Vmer_ib_Sound <- Vmer_ib_Gross
          Vmer_bk_Sound <- Vmer_bk_Gross
          
        }
        
      }
      
      # STEP 7: convert total stem wood gross volume to biomass weight 
      Wtot_ib <- Vtot_ib_Gross*data$WDSG[i]*62.4 
      Wtot_ib_red <- (Vtot_ib_Gross*R_b)*data$WDSG[i]*data$wood_prop[i]*62.4
      
      # STEP 8: predict total stem bark biomass 
      Table_S6_Pull <- Table_Pull(Table_S6a, Table_S6b, data[i,])
      Wtot_bk <- EQ_set(Table_S6_Pull, data[i,])
      Wtot_bk_red <- Wtot_bk*R_b*data$wood_prop[i]*data$bark_prop[i]
      
      # STEP 9: predict total branch biomass 
      Table_S7_Pull <- Table_Pull(Table_S7a, Table_S7b, data[i,])
      Wbranch <- EQ_set(Table_S7_Pull, data[i,])
      
      Table_S11_Pull <- Table_11_Pull(Table_S11, data[i,])
      CR <- Table_S11_Pull$Mean.CR[1]/100
      BranchRem <- (data$ht2[i] - data$ht1[i]*(1-CR))/(data$ht1[i]*CR)
      
      Wbranchred <- Wbranch*data$wood_prop[i]*data$branch_prop[i]*BranchRem
    
    } 
      
    # STEP 10: predict total aboveground biomass 
    Table_S8_Pull <- Table_Pull(Table_S8a, Table_S8b, data[i,])
    AGB_Predicted <- EQ_set(Table_S8_Pull, data[i,])

    # STEP 11: sum total stem wood biomass, total stem bark biomass, and total branch biomass
    # to obtain a second total aboveground biomass 
    AGB_Component_red <- Wtot_ib_red + Wtot_bk_red + Wbranchred
      
    # STEP 12: proportionally distribute the difference between 
    # the directly predicted total biomass and the total from the component estimates 
    AGB_Reduce <- AGB_Component_red/(Wtot_ib + Wtot_bk + Wbranch)
    AGB_Predicted_red <- AGB_Predicted*AGB_Reduce 
      
    Wood_Harmonized <- AGB_Predicted_red*(Wtot_ib_red/AGB_Component_red)
    Bark_Harmonized <- AGB_Predicted_red*(Wtot_bk_red/AGB_Component_red)
    Branch_Harmonized <- AGB_Predicted_red*(Wbranchred/AGB_Component_red)
      
    data$total_wood_bio[i] <- Wood_Harmonized
    data$total_bark_bio[i] <- Bark_Harmonized
    data$total_branch_bio[i] <- Branch_Harmonized
    data$total_ag_bio[i] <- AGB_Predicted_red
    
    # If merchantable...
    if(data$dbh[i] >= 5) {
      
      # PATH 1 OR 3 (intact top) ---------------------------------------------->
      if(data$path[i] == "1" | data$path[i] == "3") {
        
        # STEP 13: calculate an adjusted wood density 
        WDSG_Adj <- Wood_Harmonized/Vtot_ib_Gross/62.4
    
        # STEP 14: calculate an adjusted bark density 
        BKSG_Adj <- Bark_Harmonized/Vtot_bk_Gross/62.4
        
        Wmer_ib <- Vmer_ib_Gross*WDSG_Adj*62.4
        Wmer_bk <- Vmer_bk_Gross*BKSG_Adj*62.4
        Wmer_ob <- Wmer_ib + Wmer_bk
        
      # PATH 2 OR 4 (broken top) ---------------------------------------------->
      } else if(data$path[i] == "2" | data$path[i] == "4") {
        
        # STEP 13: calculate an adjusted wood density 
        WDSG_Adj <- Wood_Harmonized/(Vtot_ib_Gross*R_b)/62.4
      
        # STEP 14: calculate an adjusted bark density 
        BKSG_Adj <- Bark_Harmonized/(Vtot_bk_Gross*R_b)/62.4
        
        Wmer_ib <- Vmer_ib_Sound*WDSG_Adj*62.4
        Wmer_bk <- Vmer_bk_Sound*BKSG_Adj*62.4
        Wmer_ob <- Wmer_ib + Wmer_bk
      
      } 
      
      Wstump_ib <- Vstump_ib_Gross*WDSG_Adj*62.4
      Wstump_bk <- Vstump_bk_Gross*BKSG_Adj*62.4
      Wstump_ob <- Wstump_ib + Wstump_bk
        
      DRYBIO_TOP <- AGB_Predicted_red - Wmer_ob - Wstump_ob
        
      data$merch_wood_bio[i] <- Wmer_ib
      data$merch_bark_bio[i] <- Wmer_bk
      data$merch_total_bio[i] <- Wmer_ob
      data$merch_top_bio[i] <- DRYBIO_TOP
        
      data$stump_wood_bio[i] <- Wstump_ib
      data$stump_bark_bio[i] <- Wstump_bk
      data$stump_total_bio[i] <- Wstump_ob 
      
    }
    
    # PATH 1 (live, with intact top) ------------------------------------------>
    if(data$path[i] == "1") {
    
      # STEP 15: predict total foliage dry weight 
      Table_S9_Pull <- Table_Pull(Table_S9a, Table_S9b, data[i,])
      Wfoliage <- EQ_set(Table_S9_Pull, data[i,])
      data$foliage_bio[i] <- Wfoliage
      
      # STEP 16: get species-specific carbon fraction  
      CF <- (subset(Table_S10a, SPCD == data$species[i])$fia.wood.c)/100
    
    # PATH 2 (live, with broken top) ------------------------------------------>
    } else if(data$path[i] == "2") {
      
      # STEP 15: predict total foliage dry weight 
      Table_S9_Pull <- Table_Pull(Table_S9a, Table_S9b, data[i,])
      Wfoliage <- EQ_set(Table_S9_Pull, data[i,])
      FoliageRem <- (data$ht2[i] - data$ht1[i]*(1-CR))/(data$ht1[i]*CR)
      Wfoliagered <- Wfoliage*FoliageRem
      data$foliage_bio[i] <- Wfoliagered
      
      # STEP 16: get species-specific carbon fraction 
      CF <- (subset(Table_S10a, SPCD == data$species[i])$fia.wood.c)/100
  
    # PATH 3 OR 4 (dead) ------------------------------------------------------>
    } else if(data$path[i] == "3" | data$path[i] == "4") {
      
      # STEP 15: predict total foliage dry weight 
      Wfoliage <- 0 
      data$foliage_bio[i] <- Wfoliage
      
      # STEP 16: get species-specific carbon fraction 
      CF <- (subset(Table_S10b, S.H == data$type[i] & Decay.code == data$decay_class[i])$C.fraction)/100
    
    }

    data$carbon_frac[i] <- CF
    
  }
  
  return(data)
    
}
```


