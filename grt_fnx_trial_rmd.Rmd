
Example dataset 
```{r}
# division 240, M210, 240, M220 
data <- data.frame(
  species = c(202, 316, 631, 802),
  status = c(1, 1, 0, 1),
  dbh = c(20, 11.1, 11.3, 18.1),
  ht1 = c(110, 38, 28, 65),
  ht2 = c(NA, NA, 21, 59),
  top = c("Y", "Y", "N", "N"),
  decay_class = c(NA, NA, 2, NA),
  cull = c(0, 3, 10, 2)
)

data <- data.frame(
  species = c(202, 316, 802),
  status = c(1, 1, 1),
  dbh = c(20, 11.1, 18.1),
  ht1 = c(110, 38, 65),
  ht2 = c(NA, NA, 59),
  top = c("Y", "Y", "N"),
  decay_class = c(NA, NA, NA),
  cull = c(0, 3, 2)
)

data
```


Internal datasets 
```{r}
REF_SPECIES_BFA <- read.csv(here::here("gtr_data", "REF_SPECIES_BFA.csv"))
REF_SPECIES_BFA$k <- ifelse(REF_SPECIES_BFA$type == "S", 9, 11)
REF_SPECIES_BFA$DensProp <- ifelse(REF_SPECIES_BFA$type == "S", 0.92, 0.54)
REF_SPECIES_BFA
```

```{r}
Table_1 <- data.frame(
  type = c("H","H","H","H","H","S","S","S","S","S"),
  decay_class = c(1,2,3,4,5,1,2,3,4,5),
  wood_prop = c(0.99,0.8,0.54,0.43,0.43,0.97,1,0.92,0.55,0.55),
  bark_prop = c(1,0.8,0.5,0.2,0,1,0.8,0.5,0.2,0),
  branch_prop = c(1,0.5,0.1,0,0,1,0.5,0.1,0,0)
)

Table_1
```

```{r}
Table_S1a <- read.csv(here::here("gtr_data", "Table S1a_volib_coefs_spcd.csv"), na.strings = c(""))
Table_S1a$model <- as.character(Table_S1a$model)
Table_S1a
```

```{r}
Table_S2a <- read.csv(here::here("gtr_data", "Table S2a_volbk_coefs_spcd.csv"), na.strings = c(""))
Table_S2a
```

```{r}
Table_S3a <- read.csv(here::here("gtr_data", "Table S3a_volob_coefs_spcd.csv"), na.strings = c(""))
Table_S3a
```

```{r}
Table_S4a <- read.csv(here::here("gtr_data", "Table S4a_rcumob_coefs_spcd.csv"), na.strings = c(""))
Table_S4a
```

```{r}
Table_S5a <- read.csv(here::here("gtr_data", "Table S5a_rcumib_coefs_spcd.csv"), na.strings = c(""))
Table_S5a
```

```{r}
Table_S6a <- read.csv(here::here("gtr_data", "Table S6a_bark_biomass_coefs_spcd.csv"), na.strings = c(""))
Table_S6a
```

```{r}
Table_S7a <- read.csv(here::here("gtr_data", "Table S7a_branch_biomass_coefs_spcd.csv"), na.strings = c(""))
Table_S7a
```

```{r}
Table_S8a <- read.csv(here::here("gtr_data", "Table S8a_total_biomass_coefs_spcd.csv"), na.strings = c(""))
Table_S8a
```

```{r}
Table_S9a <- read.csv(here::here("gtr_data", "Table S9a_foliage_coefs_spcd.csv"), na.strings = c(""))
Table_S9a
```

```{r}
Table_S10a <- read.csv(here::here("gtr_data", "Table S10a_fia_wood_c_frac_live.csv"))
Table_S10a
```

```{r}
Table_S10b <- read.csv(here::here("gtr_data", "Table S10b_fia_wood_c_frac_dead.csv"))
Table_S10b
```


Supporting functions 
```{r}
EQ_set <- function(data, D, H, k) {
  
  model <- data$model[1]
  
  if(model == "1") {

    y <- data$a[1]*(D^data$b[1])*(H^data$c[1]) 
  
  } else if(model == "2") {
      
    if(D < k) {
        
      y <- data$a[1]*(D^data$b[1])*(H^data$c[1])
        
    } else if (D >= k) {
        
      y <- data$a[1]*(k^(data$b[1]-data$b1[1]))*(D^data$b1[1])*(H^data$c[1]) 
        
    }
      
  } else if (model == "3") {
  
    y <- data$a[1]*(D^(data$a1[1]*(1-exp(-data$b[1]*D))^data$c1[1]))*(H^data$c[1])
  
  } else if(model == "4") {
  
    y <- data$a[1]*(D^data$b[1])*(H^data$c[1])*exp(-(data$b1[1]*D))
  
  }

  return(y)
  
}
```

```{r}
EQ_5 <- function(data, D, H, WDSG) {

  y <- data$a[1]*(D^data$b[1])*(H^data$c[1])*WDSG
  return(y)

}
```

```{r}
EQ_6 <- function(h,H,alpha,beta) {
  
  y <- (1 - (1 - h/H)^alpha)^beta
  return(y)
  
}
```

```{r}
EQ_7 <- function(D,H,a,b,c,d,alpha,beta,h) {
  
  d - (a*D^b*H^c/0.005454154/H*alpha*beta*(1-(h/H))^(alpha-1)*(1-(1-(h/H))^alpha)^(beta-1))^0.5
  
}
```

```{r}
Table_Pull <- function(data, table_data, div) {

    if(data$species[1] %in% table_data$SPCD) {
  
      table_pull <- subset(table_data, SPCD == data$species[1])
  
      if(div %in% table_pull$DIVISION) {
    
        return_table <- subset(table_pull, DIVISION == div)
      
      } else {
      
        return_table <- subset(table_pull, is.na(DIVISION))
      
      }
      
    } #else {
      
      # put jenkins here 
      
    #}
  
  return(return_table)
      
} 
```


```{r}
NSVB(data = data, division = "240")
```


Main function 
```{r}
# other inputs that need to be added to the top level function 
# sp_codes = "4letter", input_units = "metric", output_units = "metric"

NSVB <- function(data, division) {
  
  # might include this in the prep function 
  # and remove from this spot 
  data <- merge(data, REF_SPECIES_BFA, by = "species", all.x = TRUE, all.y = FALSE)
  
  data$total_ib_bio <- as.double(NA)
  data$total_bk_bio <- as.double(NA)
  data$total_branch_bio <- as.double(NA)
  data$total_ag_bio <- as.double(NA)
  data$merch_ib_bio <- as.double(NA)
  data$merch_bk_bio <- as.double(NA)
  data$merch_ob_bio <- as.double(NA)
  data$merch_top_bio <- as.double(NA)
  data$sawlog_ib_bio <- as.double(NA)
  data$sawlog_bk_bio <- as.double(NA)
  data$sawlog_ob_bio <- as.double(NA)
  data$sawlog_top_bio <- as.double(NA)
  data$stump_ib_bio <- as.double(NA)
  data$stump_bk_bio <- as.double(NA)
  data$stump_ob_bio <- as.double(NA)
  data$foliage_bio <- as.double(NA)
  
  data$total_ib_c <- as.double(NA)
  data$total_bk_c <- as.double(NA)
  data$total_branch_c <- as.double(NA)
  data$total_ag_c <- as.double(NA)
  data$merch_ib_c <- as.double(NA)
  data$merch_bk_c <- as.double(NA)
  data$merch_ob_c <- as.double(NA)
  data$merch_top_c <- as.double(NA)
  data$sawlog_ib_c <- as.double(NA)
  data$sawlog_bk_c <- as.double(NA)
  data$sawlog_ob_c <- as.double(NA)
  data$sawlog_top_c <- as.double(NA)
  data$stump_ib_c <- as.double(NA)
  data$stump_bk_c <- as.double(NA)
  data$stump_ob_c <- as.double(NA)
  data$foliage_c <- as.double(NA)
  
  #data$path <- paste0(data$type,"_",data$status,'_',data$top)
  #data$path[data$path == "S_1_Y"] <- 1
  #data$path[data$path == "S_1_N"] <- 2
  #data$path[data$path == "S_0_Y"] <- 3
  #data$path[data$path == "S_0_N"] <- 4
  #data$path[data$path == "H_1_Y"] <- 5
  #data$path[data$path == "H_1_N"] <- 6
  #data$path[data$path == "H_0_Y"] <- 7
  #data$path[data$path == "H_0_N"] <- 8

  ###########################################
  # just for testing, delete after 
  #n <- 1
  #division <- "240"
  ###########################################
  
  n <- nrow(data)

  for (i in 1:n) {
  
    # STEP 1: predict gross total stem wood volume 
    Table_S1_Pull <- Table_Pull(data[i,], Table_S1a, division)
    Vtot_ib_Gross <- EQ_set(data = Table_S1_Pull, D = data$dbh[i], H = data$ht1[i], k = data$k[i])
    
    # STEP 2: predict gross total stem bark volume
    Table_S2_Pull <- Table_Pull(data[i,], Table_S2a, division)
    Vtot_bk_Gross <- EQ_set(data = Table_S2_Pull, D = data$dbh[i], H = data$ht1[i], k = data$k[i])
    
    # STEP 3: obtain gross total stem outside-bark volume 
    Vtot_ob_Gross <- Vtot_ib_Gross + Vtot_bk_Gross 
    
    # STEP 4: estimate heights to merchantable and sawlog top diameters
    # STEP 5: estimate stem component gross volumes 
    
    # Merchantable 
    if(data$dbh[i] >= 5) {
    
      Table_S3_Pull <- Table_Pull(data[i,], Table_S3a, division)
      Table_S4_Pull <- Table_Pull(data[i,], Table_S4a, division)
      
      EQ_7_hm <- uniroot(EQ_7, c(0,data$ht1[i]), tol = 0.001, maxiter = 100000, D = data$dbh[i], H = data$ht1[i], a = Table_S3_Pull$a, b = Table_S3_Pull$b, c = Table_S3_Pull$c, d = 4, alpha = Table_S4_Pull$alpha, beta = Table_S4_Pull$beta)
      h_m <- EQ_7_hm$root
    
      Table_S5_Pull <- Table_Pull(data, Table_S5a, division)
      
      R_1 <- EQ_6(h = 1, H = data$ht1[i], alpha = Table_S5_Pull$alpha[1], beta = Table_S5_Pull$beta[1])
      R_m <- EQ_6(h = h_m, H = data$ht1[i], alpha = Table_S5_Pull$alpha[1], beta = Table_S5_Pull$beta[1])
      
      Vmer_ib_Gross <- (R_m*Vtot_ib_Gross) - (R_1*Vtot_ib_Gross)
      Vmer_ob_Gross <- (R_m*Vtot_ob_Gross) - (R_1*Vtot_ob_Gross)
      Vmer_bk_Gross <- Vmer_ob_Gross - Vmer_ib_Gross
    
    }
    
    # Sawlog 
    if(data$type[i] == "S" && data$dbh[i] >= 9) {
      
      EQ_7_hs <- uniroot(EQ_7, c(0,data$ht1[i]), tol = 0.001, maxiter = 100000, D = data$dbh[i], H = data$ht1[i], a = Table_S3_Pull$a, b = Table_S3_Pull$b, c = Table_S3_Pull$c, d = 7, alpha = Table_S4_Pull$alpha, beta = Table_S4_Pull$beta)
      h_s <- EQ_7_hs$root
      
      R_s <- EQ_6(h = h_s, H = data$ht1[i], alpha = Table_S5_Pull$alpha[1], beta = Table_S5_Pull$beta[1])
      
      Vsaw_ib_Gross <- (R_s*Vtot_ib_Gross) - (R_1*Vtot_ib_Gross)
      Vsaw_ob_Gross <- (R_s*Vtot_ob_Gross) - (R_1*Vtot_ob_Gross)
      Vsaw_bk_Gross <- Vsaw_ob_Gross - Vsaw_ib_Gross
      
      Vstump_ob_Gross <- (R_1*Vtot_ob_Gross)
      Vstump_ib_Gross <- (R_1*Vtot_ib_Gross)
      Vstump_bk_Gross <- Vstump_ob_Gross - Vstump_ib_Gross
      
      # possibly delete? 
      #Vtop_ob_Gross <- Vtot_ob_Gross - Vmer_ob_Gross - Vstump_ob_Gross 
      #Vtop_ib_Gross <- Vtot_ib_Gross - Vmer_ib_Gross - Vstump_ib_Gross 
      #Vtop_bk_Gross <- Vtop_ob_Gross - Vtop_ib_Gross
      
    } else if (data$type[i] == "H" && data$dbh[i] >= 11) {
      
      
    }
    
    # STEP 6: estimate stem component sound volumes 
    Vtot_ib_Sound <- Vtot_ib_Gross*(1 - data$cull[i]/100) 
    Vtot_bk_Sound <- Vtot_bk_Gross
    Vtot_ob_Sound <- Vtot_ib_Sound + Vtot_bk_Sound
    
    # STEP 7: convert total stem wood gross volume to biomass weight 
    Wtot_ib <- Vtot_ib_Gross*data$WDSG[i]*62.4 
    Wtot_ib_red <- Vtot_ib_Gross*(1 - data$cull[i]/100*(1-data$DensProp[i]))*data$WDSG[i]*62.4 
    
    # STEP 8: predict total stem bark biomass 
    Table_S6_Pull <- Table_Pull(data[i,], Table_S6a, division)
    Wtot_bk <- EQ_set(data = Table_S6_Pull, D = data$dbh[i], H = data$ht1[i], k = data$k[i])
    Wtot_bk_red <- Wtot_bk
    
    # STEP 9: predict total branch biomass 
    Table_S7_Pull <- Table_Pull(data[i,], Table_S7a, division)
    Wbranch <- EQ_set(data = Table_S7_Pull, D = data$dbh[i], H = data$ht1[i], k = data$k[i])
    Wbranchred <- Wbranch
    
    # STEP 10: predict total aboveground biomass 
    Table_S8_Pull <- Table_Pull(data[i,], Table_S8a, division)
    AGB_Predicted <- EQ_set(data = Table_S8_Pull, D = data$dbh[i], H = data$ht1[i], k = data$k[i])

    # STEP 11: sum total stem wood biomass, total stem bark biomass, and total branch biomass
    # to obtain a second total aboveground biomass 
    AGB_Component_red <- Wtot_ib_red + Wtot_bk_red + Wbranchred
    
    # STEP 12: proportionally distribute the difference between 
    # the directly predicted total biomass and the total from the component estimates 
    AGB_Reduce <- AGB_Component_red/(Wtot_ib + Wtot_bk + Wbranch)
    AGB_Predicted_red <- AGB_Predicted*AGB_Reduce 
    AGB_Diff <- AGB_Predicted_red - AGB_Component_red 
    
    Wood_Harmonized <- AGB_Predicted_red*(Wtot_ib_red/AGB_Component_red)
    Bark_Harmonized <- AGB_Predicted_red*(Wtot_bk_red/AGB_Component_red)
    Branch_Harmonized <- AGB_Predicted_red*(Wbranchred/AGB_Component_red)
    
    # STEP 13: calculate an adjusted wood density 
    WDSG_Adj <- Wood_Harmonized/Vtot_ib_Gross/62.4
    
    # STEP 14: calculate an adjusted bark density 
    BKSG_Adj <- Bark_Harmonized/Vtot_bk_Gross/62.4 
    
    Wmer_ib <- Vmer_ib_Gross*WDSG_Adj*62.4
    Wmer_bk <- Vmer_bk_Gross*BKSG_Adj*62.4
    Wmer_ob <- Wmer_ib + Wmer_bk 
    
    Wsaw_ib <- Vsaw_ib_Gross*WDSG_Adj*62.4
    Wsaw_bk <- Vsaw_bk_Gross*BKSG_Adj*62.4
    Wsaw_ob <- Wsaw_ib + Wsaw_bk 
    
    Wstump_ib <- Vstump_ib_Gross*WDSG_Adj*62.4
    Wstump_bk <- Vstump_bk_Gross*BKSG_Adj*62.4
    Wstump_ob <- Wstump_ib + Wstump_bk 
    
    DRYBIO_TOP_mer <- AGB_Predicted_red - Wmer_ob - Wstump_ob
    DRYBIO_TOP_saw <- AGB_Predicted_red - Wsaw_ob - Wstump_ob
    
    # STEP 15: predict total foliage dry weight 
    Table_S9_Pull <- Table_Pull(data[i,], Table_S9a, division)
    Wfoliage <- EQ_set(data = Table_S9_Pull, D = data$dbh[i], H = data$ht1[i], k = data$k[i])
    Wfoliagered <- Wfoliage 
    
    # STEP 16: estimate total aboveground carbon 
    CF <- (subset(Table_S10a, SPCD == data$species[i])$fia.wood.c)/100
    
    # add calculations to data 
    data$total_ib_bio[i] <-  Wood_Harmonized
    data$total_bk_bio[i] <- Bark_Harmonized
    data$total_branch_bio[i] <- Branch_Harmonized
    data$total_ag_bio[i] <- AGB_Predicted_red
    data$merch_ib_bio[i] <- Wmer_ib
    data$merch_bk_bio[i] <- Wmer_bk
    data$merch_ob_bio[i] <- Wmer_ob
    data$merch_top_bio[i] <- DRYBIO_TOP_mer
    data$sawlog_ib_bio[i] <- Wsaw_ib
    data$sawlog_bk_bio[i] <- Wstump_bk
    data$sawlog_ob_bio[i] <- Wsaw_ob 
    data$sawlog_top_bio[i] <- DRYBIO_TOP_saw
    data$stump_ib_bio[i] <- Wstump_ib
    data$stump_bk_bio[i] <- Wstump_bk
    data$stump_ob_bio[i] <- Wstump_ob 
    data$foliage_bio[i] <- Wfoliagered
    
    data$total_ib_c[i] <- Wood_Harmonized*CF
    data$total_bk_c[i] <- Bark_Harmonized*CF
    data$total_branch_c[i] <- Branch_Harmonized*CF
    data$total_ag_c[i] <- AGB_Predicted_red*CF
    data$merch_ib_c[i] <- Wmer_ib*CF
    data$merch_bk_c[i] <- Wmer_bk*CF
    data$merch_ob_c[i] <- Wmer_ob*CF
    data$merch_top_c[i] <- DRYBIO_TOP_mer*CF
    data$sawlog_ib_c[i] <- Wsaw_ib*CF
    data$sawlog_bk_c[i] <- Wstump_bk*CF
    data$sawlog_ob_c[i] <- Wsaw_ob*CF
    data$sawlog_top_c[i] <- DRYBIO_TOP_saw*CF
    data$stump_ib_c[i] <- Wstump_ib*CF
    data$stump_bk_c[i] <- Wstump_bk*CF
    data$stump_ob_c[i] <- Wstump_ob*CF
    data$foliage_c[i] <- Wfoliagered*0.5
    
  }
  
  return(data)
    
}
```


